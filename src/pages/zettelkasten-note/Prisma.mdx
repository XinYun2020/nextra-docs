# Prisma #ORM #async

## What?

- [ORM (Object–Relational Mapping)](https://www.notion.so/ORM-Object-Relational-Mapping-8772643420624c7db67f4b2f262049ff)
- Client - Server(Prisma) - Database
  - **Database communication**: communicate and interact with any type of **database** using **same syntax**
    - [PostgreSQL #rdbms](https://www.notion.so/PostgreSQL-rdbms-339fddf0c6cf46d3a71171db8251e047)
    - [MySQL #rdbms](https://www.notion.so/MySQL-rdbms-66f8a7f73e6f4c898f0f0fca683954a9)
    - [Microsoft SQL Server #MSSQL #rdbms](https://www.notion.so/Microsoft-SQL-Server-MSSQL-rdbms-b13688e1c2634893b6123778a93cace2)
    - [CockroachDB #rdbms](https://www.notion.so/CockroachDB-rdbms-4ad672f849324170b535291709632af5)
    - [SQLite #ORM](https://www.notion.so/SQLite-ORM-fdf126d3c7214971ac24f2aec087ba63)
    - [MongoDB #nosql #MERN](https://www.notion.so/MongoDB-nosql-MERN-9f199cb4d934410a8e219df942f81df9)
    - CockroachDB
  - **Server safe**: a type-safe way of interacting with databases by generating SQL queries at runtime based on [prisma/schema.prisma](https://www.notion.so/prisma-schema-prisma-d90ea45f16b048beae68ce4ff092a089)

### What Is the Process?

1. Prisma Schema [prisma/schema.prisma](https://www.notion.so/prisma-schema-prisma-d90ea45f16b048beae68ce4ff092a089)
   - Data model [🔗](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#:~:text=Components%20%2F%20Prisma%20schema-,data%20model,-The%20data%20model)
   - clear schema language ⇒ express data relationship in human-readable way
   - Or schema can also be automatically inferred from any existing DB
2. Schema ⇒ type definition
   1. allowing perform typesafe CRUD operations with own DB model
3. Migrations as ts structure evolves
4. Visualize data
   1. Prisma studio ⇒ `npx prisma studio` ⇒ view and manage all tables and rows in browser

## Why?

### Why Prima?

- Keeps database schema in sync
- and maintaining existing data
- code is significantly more concise than write in raw [SQL (Structured Query Language)](https://www.notion.so/SQL-Structured-Query-Language-ec04088cbc424a2c87fdd6e19480db7d)

### Why Shouldn't?

- competitor
  - [DrizzleORM ](https://www.notion.so/DrizzleORM-1ae823992db841ba84fb5f0be7ece715)

## How?

### How to Setup the Project?

- [Quickstart with TypeScript & SQLite (prisma.io)](https://www.prisma.io/docs/getting-started/quickstart)
  - [Start from scratch with relational databases (15 min) | typescript-postgresql (prisma.io)](https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/relational-databases-typescript-postgresql) [MySQL #rdbms](https://www.notion.so/MySQL-rdbms-66f8a7f73e6f4c898f0f0fca683954a9) / [PostgreSQL #rdbms](https://www.notion.so/PostgreSQL-rdbms-339fddf0c6cf46d3a71171db8251e047) / [Microsoft SQL Server #MSSQL #rdbms](https://www.notion.so/Microsoft-SQL-Server-MSSQL-rdbms-b13688e1c2634893b6123778a93cace2)…
    ```bash
    npm init -y ## create package.json
    npm install prisma typescript ts-node @types/node --save-dev
    npm i --save-dev nodemon
    ```
    - `nodemon` ⇒ refresh server every time we make changes
    1. `npx tsc --init` create [tsconfig.json (`npx tsc --init`)](https://www.notion.so/tsconfig-json-npx-tsc-init-5874fb3a066c4db786e591e44b1cf975) [🔗](https://v1.prisma.io/docs/1.34/get-started/01-setting-up-prisma-demo-server-TYPESCRIPT-t001/#:~:text=Create%20your-,tsconfig.json,-with%20the%20following)
    2. `npx prisma` invoke Prisma CLI
    3. `npx prisma init` creating [prisma/schema.prisma](https://www.notion.so/prisma-schema-prisma-d90ea45f16b048beae68ce4ff092a089) (setup Prisma project & setup database)
       1. `npx prisma init --datasource-provider SQLite`
       2. `npx prisma init --datasource-provider postgresql` init basic file and use Postgres by default
    4. setup database URL and the [.env.local #security](https://www.notion.so/env-local-security-70a3ee6802d54a8a9156637a961ff5cb)
       - `.env`
         - find `DATABASE_URL=”postgresql://...”` from
           - [Railway.app](https://www.notion.so/Railway-app-8a03286a575d42adb6e6d54af515a5ab)
    5. `npm i @prisma/client` install Prisma Client
       1. Instantiate client ⇒ [client.js](https://www.notion.so/client-js-3a8648356fac4e58a3bfd0ac2974f365)
    6. modify [prisma/schema.prisma](https://www.notion.so/prisma-schema-prisma-d90ea45f16b048beae68ce4ff092a089)
    - migrate: `npx prisma migrate dev --name init` ⇒ generating
      - check table created in
        - [Railway.app](https://www.notion.so/Railway-app-8a03286a575d42adb6e6d54af515a5ab)
  - [Start from scratch with MongoDB (15 min) | typescript-mongodb (prisma.io)](https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/mongodb-typescript-mongodb) [MongoDB #nosql #MERN](https://www.notion.so/MongoDB-nosql-MERN-9f199cb4d934410a8e219df942f81df9)

### How to use Prisma?

1. Define/create schema [prisma/schema.prisma](https://www.notion.so/prisma-schema-prisma-d90ea45f16b048beae68ce4ff092a089)
2. /update database structure can be handled automatically
   - `npx prisma migrate`
     - or `npx prisma migrate dev --name init` ## give the name of init
     - `npm prisma migrate dev --name test2`
   - migration file will interact with database and make all changes
     - /prisma/migrations/init/migration.sql
3. Install client
   1. `npx i @prisma/client`
4. interact with the DB on the server
   - `npx prisma generate` ## go through all the steps generate based on whatever provider we want
5. import Prisma in Client
1. setup package.json scripts
    - `“devStart”: “nodemon script.ts”` ## npm run devStart
- **READING DATA**
    
    ```jsx
    // npm run devStart ## to run the script.ts
    // run `npx prisma generate`
    import { PrismaClient } from "@prisma/client";
    const prisma = new PrismaClient(); // manage different db for you !! only use one instance of it
    // const prisma = new PrismaClient({log:["query"]}); // log the query in the terminal
    
    // everything in prisma is async
    async function main() {
      // ... you will write your Prisma Client queries here
    
      // delete all users in the database
      await prisma.user.deleteMany(); // How to delete everything form the database
        /*
        const user = await prisma.user.createMany({
            where: {
                AND: [
                    { email: { startsWith: "alice"} },
                    { email: { endsWith: "@test.com"} },
                ]
                OR: [],
                NOR: [],
                // queries
                name: { equals: "Alice" },
                name: { not: "Alice" },
                name: { in: ["Alice", "Kyle"] },
                name: { notIn: ["Alice", "Kyle"] },
                age: { lt: 20 }, // age less than 20    
                age: { lte: 20 }, // age less than or equal 20    
                age: { gt: 20 }, // age greater than 20    
                age: { gte: 20 }, // age greater than  or equal 20    
                email: { contains: "@test.com"}, 
                email: { endsWith: "@test.com"}, 
                email: { startsWith: "alice"}, 
    
            },
            distinct: ["name", "age"], // return one single Alice
            orderBy: {
                age: "asc", // "desc"
            }
            take: 2, // pagination
            skip: 1, // skip the first user Alice, get the next two
    
        })
            - cannot use select function
        
        const user = await prisma.user.findUnique({ 
            where: {
                email: "alice@test.com",
                age_name: { // this is generated by @@unique([age, name])
                    age: 24,
                    name: "Alice"
                }
            }
        })
            - find by unique keys
            - only return one
            - can use select and include function 
    
    		// Find the first matching 
        const user = await prisma.user.findFirst({ 
            where: {
                name: "Alice"
                }
        })
            - only return one
    
        const user = await prisma.user.findMany()   // get all users
        const user = await prisma.user.findMany({
            where: {
                writtenPosts: {
                    every: {
                        title: { startsWith: "Test" },
                        createdAt: new Date(),
                    },
                    none: {},
                    some: {},
    
                }
            }
        })
        const user = await prisma.post.findMany({
            where:{
                author:{
                    is: {
                        age: 24,
                    }
                    isNot: {}
                }
            }
        })
    
        */
    
      const user = await prisma.user.create({
        data: {
          name: "Alice",
          email: "alice@test.com",
          age: 24,
          userPreference: {
            // create function allows create a brand new user preference
            create: {
              emailUpdates: true,
            },
          },
        },
    
        /* CAN ONLY INCLUDE OR SELECT CANNOT DO BOTH */
    
        // include the userPreference model
        include: {
          userPreference: true,
        },
        // only return the name property
        select: {
          name: true,
          userPreference: { select: { id: true } }, // only the id of the userPreference
        },
      });
    
      console.log(user);
    }
    
    main()
      .catch((e) => {
        console.error(e.message); // catching any errors and printing them out
      })
      .finally(async () => {
        await prisma.$disconnect(); // finally disconnected
      });
    ```
    
- **UPDATE DATA**
    
    ```tsx
    async function main() {
      // update first user
      // - can use include and select function
      const user = await prisma.user.update({
        where: {
          email: "alice@test.com", // take this
        },
        data: {
          email: "alice@test2.com", // change to this
        },
      });
    
      // updateMany: some as update but update all users
      const users = await prisma.user.updateMany({
        where: {
          name: "Alice", // take this
        },
        data: {
          name: "New Alice", // change all matching to this
        },
      });
      console.log(user);
    }
    
    const user = await prisma.user.update({
        where: {
          email: "alice@test.com", // take this
        },
        data: {
          email: "alice@test2.com", // change to this
          age: {
            increment: 1, // increment the int
            decrement: 1,
            multiply: 1,
            divide: 1,
          },
          // update user and give a new user preference with this information
          userPreference: {
            create: {
              emailUpdates: true,
            },
            connect: {
              id: "askdjflkasjdlfkjalskdjf",
            },
          },
        },
      });
    ```
    
- **DELETE DATA**
    
    ```jsx
    async function main() {
      // simiar to find
      // must be unique field
      const user = await prisma.user.delete({
        where: {
          email: "alice@test.com",
        },
      });
      console.log(user);
    
      // deleteMany
      const users = await prisma.user.deleteMany({
        where: {
          age: { gt: 20 },
        },
      });
      
      // delete all user in the database
      const users = await prisma.user.deleteMany()
    }
    ```



### How to format Prisma file?

- `npx prisma format`
- Plugin (can set in setting.json `[prisma]`)
